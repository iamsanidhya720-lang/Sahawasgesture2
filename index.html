<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gesture Zoom + 3D Heart</title>
  <link rel="icon" href="data:,">
  <style>
    body { margin:0; background:#000; color:#fff; font-family:sans-serif; }
    header { display:flex; justify-content:space-between; padding:10px; background:#111; }
    button,input[type=file] { margin-left:8px; padding:6px 12px; border-radius:6px; border:none; cursor:pointer; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; height:80vh; padding:10px; }
    .panel { position:relative; background:#050505; border-radius:10px; overflow:hidden; }
    video,canvas { width:100%; height:100%; object-fit:contain; }
    #toolbar { padding:10px; background:#111; display:flex; gap:10px; }
    #heartCanvas { display:none; width:100%; height:100%; }
  </style>

  <!-- MediaPipe libraries (globals) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>
</head>
<body>
  <header><h1>Gesture Zoom + 3D Heart</h1></header>
  <div id="toolbar">
    <input type="file" id="fileInput" accept="image/*">
    <button id="toggleHeartBtn">Show 3D Heart</button>
  </div>
  <div class="grid">
    <div class="panel">
      <canvas id="imageCanvas"></canvas>
    </div>
    <div class="panel">
      <video id="cam" autoplay playsinline muted></video>
      <canvas id="heartCanvas"></canvas>
    </div>
  </div>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/controls/OrbitControls.js";

    // ===== Image upload / zoom state =====
    const fileInput=document.getElementById('fileInput');
    const imageCanvas=document.getElementById('imageCanvas');
    const ictx=imageCanvas.getContext('2d');
    let img=new Image();
    let imgState={loaded:false, scale:1, x:0, y:0};

    function fitImage(){
      imageCanvas.width=imageCanvas.clientWidth;
      imageCanvas.height=imageCanvas.clientHeight;
      imgState.scale=Math.min(imageCanvas.width/img.width, imageCanvas.height/img.height);
      imgState.x=(imageCanvas.width-img.width*imgState.scale)/2;
      imgState.y=(imageCanvas.height-img.height*imgState.scale)/2;
      drawImage();
    }
    function drawImage(){
      if(!imgState.loaded) return;
      ictx.clearRect(0,0,imageCanvas.width,imageCanvas.height);
      ictx.drawImage(img,imgState.x,imgState.y,img.width*imgState.scale,img.height*imgState.scale);
    }
    fileInput.addEventListener('change',e=>{
      const f=e.target.files[0];
      if(!f) return;
      const r=new FileReader();
      r.onload=ev=>{ img.src=ev.target.result; };
      r.readAsDataURL(f);
    });
    img.onload=()=>{ imgState.loaded=true; fitImage(); };
    window.addEventListener('resize',fitImage);

    // ===== MediaPipe Hands Setup =====
    const Hands=window.Hands;
    const Camera=window.Camera;
    let hands=new Hands({locateFile: (file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({maxNumHands:2, modelComplexity:1, minDetectionConfidence:0.7, minTrackingConfidence:0.7});

    hands.onResults(results=>{
      if(results.multiHandLandmarks && results.multiHandLandmarks.length>0){
        // Example: use pinch distance between fingers for zoom
        const lm=results.multiHandLandmarks[0];
        const dx=lm[4].x-lm[8].x;
        const dy=lm[4].y-lm[8].y;
        const dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<0.05) imgState.scale*=0.95;
        if(dist>0.2) imgState.scale*=1.05;
        drawImage();
      }
    });

    const camEl=document.getElementById('cam');
    const mediacamera=new Camera(camEl,{onFrame:async()=>{await hands.send({image:camEl});},width:640,height:480});
    mediacamera.start();

    // ===== 3D Heart Setup =====
    const heartCanvas=document.getElementById('heartCanvas');
    const toggleHeartBtn=document.getElementById('toggleHeartBtn');
    let renderer,scene,camera,heartMesh,controls,animId;

    function startHeart(){
      heartCanvas.style.display="block";
      renderer=new THREE.WebGLRenderer({canvas:heartCanvas,antialias:true});
      renderer.setSize(heartCanvas.clientWidth,heartCanvas.clientHeight);
      scene=new THREE.Scene();
      scene.background=new THREE.Color(0x000000);
      camera=new THREE.PerspectiveCamera(45,heartCanvas.clientWidth/heartCanvas.clientHeight,0.1,100);
      camera.position.z=5;
      controls=new OrbitControls(camera,heartCanvas);
      controls.enableDamping=true;

      const light=new THREE.PointLight(0xffffff,1);
      light.position.set(5,5,5);
      scene.add(light);

      const heartShape=new THREE.Shape();
      heartShape.moveTo(0,0.5);
      heartShape.bezierCurveTo(0,0.5,-0.25,0.5,-0.25,0.25);
      heartShape.bezierCurveTo(-0.25,0,0,-0.1,0,-0.5);
      heartShape.bezierCurveTo(0,-0.1,0.25,0,0.25,0.25);
      heartShape.bezierCurveTo(0.25,0.5,0,0.5,0,0.5);
      const extrudeSettings={depth:0.3,bevelEnabled:true,bevelSegments:2,steps:2,bevelSize:0.05,bevelThickness:0.05};
      const geometry=new THREE.ExtrudeGeometry(heartShape,extrudeSettings);
      const material=new THREE.MeshPhongMaterial({color:0xff0000,shininess:100});
      heartMesh=new THREE.Mesh(geometry,material);
      scene.add(heartMesh);

      function animate(){
        animId=requestAnimationFrame(animate);
        heartMesh.rotation.y+=0.01;
        controls.update();
        renderer.render(scene,camera);
      }
      animate();
    }

    toggleHeartBtn.addEventListener('click',()=>{
      if(heartCanvas.style.display==="block"){
        cancelAnimationFrame(animId);
        heartCanvas.style.display="none";
        renderer.dispose();
      }else{
        startHeart();
      }
    });
  </script>
</body>
</html>
